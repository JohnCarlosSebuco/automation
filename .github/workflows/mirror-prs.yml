name: Mirror PRs to Upstream

on:
  workflow_dispatch:

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Mirror open PRs from xcent-next-dev to axiononeproject/xcent-next
        env:
          GH_TOKEN: ${{ secrets.SYNC_PAT }}
        run: |
          set -euo pipefail

          DEV_REPO="JohnCarlosSebuco/xcent-next-dev"
          UPSTREAM_REPO="axiononeproject/xcent-next"

          # Get all open PRs targeting staging in the dev repo
          PRS=$(gh pr list --repo "$DEV_REPO" --base staging --state open --json number,title,headRefName,body --jq '.[] | @base64')

          if [ -z "$PRS" ]; then
            echo "No open PRs targeting staging. Nothing to do."
            exit 0
          fi

          # Bare clone of dev repo for efficient branch pushing
          git clone --bare "https://x-access-token:${GH_TOKEN}@github.com/${DEV_REPO}.git" dev-bare
          cd dev-bare

          # Add upstream as a remote
          git remote add upstream "https://x-access-token:${GH_TOKEN}@github.com/${UPSTREAM_REPO}.git"

          for PR_B64 in $PRS; do
            PR_JSON=$(echo "$PR_B64" | base64 --decode)
            PR_NUMBER=$(echo "$PR_JSON" | jq -r '.number')
            PR_TITLE=$(echo "$PR_JSON" | jq -r '.title')
            PR_BRANCH=$(echo "$PR_JSON" | jq -r '.headRefName')
            PR_BODY=$(echo "$PR_JSON" | jq -r '.body')

            echo "=========="
            echo "Processing PR #${PR_NUMBER}: ${PR_TITLE} (branch: ${PR_BRANCH})"

            # Check if this branch already has a merged PR in upstream (skip if so)
            MERGED_PR=$(gh pr list --repo "$UPSTREAM_REPO" --head "$PR_BRANCH" --base staging --state merged --json number --jq '.[0].number' 2>/dev/null || echo "")
            if [ -n "$MERGED_PR" ] && [ "$MERGED_PR" != "null" ]; then
              echo "Skipping: mirror PR #${MERGED_PR} was already merged in ${UPSTREAM_REPO}."
              continue
            fi

            # Check if a mirror PR already exists (open) in upstream with the same branch
            EXISTING_PR=$(gh pr list --repo "$UPSTREAM_REPO" --head "$PR_BRANCH" --base staging --state open --json number,title --jq '.[0]' 2>/dev/null || echo "")

            # Force-push the branch to upstream
            echo "Pushing ${PR_BRANCH} to ${UPSTREAM_REPO}..."
            git push upstream "refs/heads/${PR_BRANCH}:refs/heads/${PR_BRANCH}" --force

            if [ -z "$EXISTING_PR" ] || [ "$EXISTING_PR" = "null" ]; then
              echo "Creating mirror PR in ${UPSTREAM_REPO}..."
              gh pr create \
                --repo "$UPSTREAM_REPO" \
                --base staging \
                --head "$PR_BRANCH" \
                --title "$PR_TITLE" \
                --body ""
              echo "Mirror PR created."
            else
              EXISTING_TITLE=$(echo "$EXISTING_PR" | jq -r '.title')
              EXISTING_NUMBER=$(echo "$EXISTING_PR" | jq -r '.number')
              echo "Mirror PR #${EXISTING_NUMBER} already exists (open). Updating branch."

              # Update title if it changed
              if [ "$EXISTING_TITLE" != "$PR_TITLE" ]; then
                echo "Title changed, updating..."
                gh pr edit "$EXISTING_NUMBER" --repo "$UPSTREAM_REPO" --title "$PR_TITLE"
              fi
            fi
          done

          echo "=========="
          echo "All PRs processed."
