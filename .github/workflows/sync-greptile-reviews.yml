name: Sync Greptile Reviews

on:
  workflow_dispatch:

jobs:
  sync-reviews:
    runs-on: ubuntu-latest
    steps:
      - name: Sync greptile code reviews to dev repo issues
        env:
          GH_TOKEN: ${{ secrets.SYNC_PAT }}
        run: |
          set -euo pipefail

          UPSTREAM_REPO="axiononeproject/xcent-next"
          DEV_REPO="JohnCarlosSebuco/xcent-next-dev"
          AUTHOR="JohnCarlosSebuco"
          BOT_LOGIN="greptile-apps[bot]"

          # List open PRs targeting staging authored by JohnCarlosSebuco
          PRS=$(gh pr list --repo "$UPSTREAM_REPO" --base staging --state open --author "$AUTHOR" --json number,headRefName --jq '.[] | @base64')

          if [ -z "$PRS" ]; then
            echo "No open PRs targeting staging by ${AUTHOR}. Nothing to do."
            exit 0
          fi

          for PR_B64 in $PRS; do
            PR_JSON=$(echo "$PR_B64" | base64 --decode)
            PR_NUMBER=$(echo "$PR_JSON" | jq -r '.number')
            PR_BRANCH=$(echo "$PR_JSON" | jq -r '.headRefName')

            echo "=========="
            echo "Processing PR #${PR_NUMBER} (branch: ${PR_BRANCH})"

            # Dedup check: search for existing issue in dev repo (open OR closed)
            ISSUE_TITLE="Code Review - ${PR_BRANCH}"
            OPEN_MATCH=$(gh issue list --repo "$DEV_REPO" --state open --search "\"${ISSUE_TITLE}\" in:title" --json number,title --jq "[.[] | select(.title == \"${ISSUE_TITLE}\")] | length")
            CLOSED_MATCH=$(gh issue list --repo "$DEV_REPO" --state closed --search "\"${ISSUE_TITLE}\" in:title" --json number,title --jq "[.[] | select(.title == \"${ISSUE_TITLE}\")] | length")

            if [ "$OPEN_MATCH" -gt 0 ] || [ "$CLOSED_MATCH" -gt 0 ]; then
              echo "Issue already exists for '${ISSUE_TITLE}'. Skipping."
              continue
            fi

            # Fetch greptile inline comments
            COMMENTS=$(gh api "repos/${UPSTREAM_REPO}/pulls/${PR_NUMBER}/comments" --jq "[.[] | select(.user.login == \"${BOT_LOGIN}\")] | map({path: .path, start_line: .start_line, line: .line, body: .body})")

            COMMENT_COUNT=$(echo "$COMMENTS" | jq 'length')

            # Fetch greptile review bodies (Additional Comments)
            REVIEWS=$(gh api "repos/${UPSTREAM_REPO}/pulls/${PR_NUMBER}/reviews" \
              --jq "[.[] | select(.user.login == \"${BOT_LOGIN}\" and .body != null and .body != \"\")]")

            ADDITIONAL_BODY=""
            while IFS= read -r review; do
              REVIEW_BODY=$(echo "$review" | jq -r '.body')
              # Strip metadata lines
              CLEANED=$(echo "$REVIEW_BODY" | sed \
                -e '/^[0-9]\+ files\? reviewed/d' \
                -e '/^\*\*Additional Comments/d' \
                -e '/^Prompt To Fix With AI$/d' \
                -e '/^Edit Code Review Agent Settings/d' \
                -e '/^$/d')
              if [ -n "$CLEANED" ]; then
                ADDITIONAL_BODY="$CLEANED"
              fi
            done < <(echo "$REVIEWS" | jq -c '.[]')

            ADDITIONAL_COUNT=0
            if [ -n "$ADDITIONAL_BODY" ]; then
              ADDITIONAL_COUNT=1
            fi
            TOTAL_COUNT=$((COMMENT_COUNT + ADDITIONAL_COUNT))

            if [ "$TOTAL_COUNT" -eq 0 ]; then
              echo "No greptile comments on PR #${PR_NUMBER}. Skipping."
              continue
            fi

            echo "Found ${COMMENT_COUNT} inline + ${ADDITIONAL_COUNT} additional = ${TOTAL_COUNT} total comment(s)."

            # Create the issue with empty body
            ISSUE_URL=$(gh issue create --repo "$DEV_REPO" --title "$ISSUE_TITLE" --body "")
            ISSUE_NUMBER=$(echo "$ISSUE_URL" | grep -o '[0-9]*$')
            echo "Created issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}"

            # Post each inline comment as a separate issue comment
            POSTED=0
            while IFS= read -r comment; do
              FILE_PATH=$(echo "$comment" | jq -r '.path')
              START_LINE=$(echo "$comment" | jq -r '.start_line')
              END_LINE=$(echo "$comment" | jq -r '.line')
              COMMENT_BODY=$(echo "$comment" | jq -r '.body')
              COMMENT_BODY=$(echo "$COMMENT_BODY" | sed '/^Prompt To Fix With AI$/d')

              if [ "$START_LINE" != "null" ] && [ "$START_LINE" != "$END_LINE" ]; then
                HEADER="\`${FILE_PATH}\` (lines ${START_LINE}-${END_LINE})"
              else
                HEADER="\`${FILE_PATH}\` (line ${END_LINE})"
              fi

              COMMENT_FILE=$(mktemp)
              printf '%s\n\n%s\n' "$HEADER" "$COMMENT_BODY" > "$COMMENT_FILE"

              # Retry up to 3 times per comment
              for ATTEMPT in 1 2 3; do
                if gh issue comment "$ISSUE_NUMBER" --repo "$DEV_REPO" --body-file "$COMMENT_FILE"; then
                  POSTED=$((POSTED + 1))
                  break
                fi
                echo "Retry ${ATTEMPT}/3 for comment on ${FILE_PATH}..."
                sleep $((ATTEMPT * 2))
              done

              rm -f "$COMMENT_FILE"
              sleep 1
            done < <(echo "$COMMENTS" | jq -c '.[]')

            # Post the additional comment (if any)
            if [ -n "$ADDITIONAL_BODY" ]; then
              COMMENT_FILE=$(mktemp)
              printf '%s\n' "$ADDITIONAL_BODY" > "$COMMENT_FILE"
              for ATTEMPT in 1 2 3; do
                if gh issue comment "$ISSUE_NUMBER" --repo "$DEV_REPO" --body-file "$COMMENT_FILE"; then
                  POSTED=$((POSTED + 1))
                  break
                fi
                echo "Retry ${ATTEMPT}/3 for additional comment..."
                sleep $((ATTEMPT * 2))
              done
              rm -f "$COMMENT_FILE"
            fi

            echo "Posted ${POSTED}/${TOTAL_COUNT} comments to issue #${ISSUE_NUMBER}."
            if [ "$POSTED" -ne "$TOTAL_COUNT" ]; then
              echo "::warning::Only posted ${POSTED} of ${TOTAL_COUNT} comments for PR #${PR_NUMBER}."
            fi
          done

          echo "=========="
          echo "All PRs processed."
