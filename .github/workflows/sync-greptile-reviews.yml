name: Sync Greptile Reviews

on:
  workflow_dispatch:

jobs:
  sync-reviews:
    runs-on: ubuntu-latest
    steps:
      - name: Sync greptile code reviews to dev repo issues
        env:
          GH_TOKEN: ${{ secrets.SYNC_PAT }}
        run: |
          set -euo pipefail

          UPSTREAM_REPO="axiononeproject/xcent-next"
          DEV_REPO="JohnCarlosSebuco/xcent-next-dev"
          AUTHOR="JohnCarlosSebuco"
          BOT_LOGIN="greptile-apps[bot]"

          # List open PRs targeting staging authored by JohnCarlosSebuco
          PRS=$(gh pr list --repo "$UPSTREAM_REPO" --base staging --state open --author "$AUTHOR" --json number,headRefName,url --jq '.[] | @base64')

          if [ -z "$PRS" ]; then
            echo "No open PRs targeting staging by ${AUTHOR}. Nothing to do."
            exit 0
          fi

          for PR_B64 in $PRS; do
            PR_JSON=$(echo "$PR_B64" | base64 --decode)
            PR_NUMBER=$(echo "$PR_JSON" | jq -r '.number')
            PR_BRANCH=$(echo "$PR_JSON" | jq -r '.headRefName')
            PR_URL=$(echo "$PR_JSON" | jq -r '.url')

            echo "=========="
            echo "Processing PR #${PR_NUMBER} (branch: ${PR_BRANCH})"

            # Dedup check: search for existing issue in dev repo (open OR closed)
            ISSUE_TITLE="Code Review - ${PR_BRANCH}"
            OPEN_MATCH=$(gh issue list --repo "$DEV_REPO" --state open --search "\"${ISSUE_TITLE}\" in:title" --json number,title --jq "[.[] | select(.title == \"${ISSUE_TITLE}\")] | length")
            CLOSED_MATCH=$(gh issue list --repo "$DEV_REPO" --state closed --search "\"${ISSUE_TITLE}\" in:title" --json number,title --jq "[.[] | select(.title == \"${ISSUE_TITLE}\")] | length")

            if [ "$OPEN_MATCH" -gt 0 ] || [ "$CLOSED_MATCH" -gt 0 ]; then
              echo "Issue already exists for '${ISSUE_TITLE}'. Skipping."
              continue
            fi

            # Fetch greptile review summaries
            REVIEWS=$(gh api "repos/${UPSTREAM_REPO}/pulls/${PR_NUMBER}/reviews" --jq "[.[] | select(.user.login == \"${BOT_LOGIN}\")] | map({body: .body})")

            # Fetch greptile inline comments
            COMMENTS=$(gh api "repos/${UPSTREAM_REPO}/pulls/${PR_NUMBER}/comments" --jq "[.[] | select(.user.login == \"${BOT_LOGIN}\")] | map({path: .path, start_line: .start_line, line: .line, body: .body})")

            REVIEW_COUNT=$(echo "$REVIEWS" | jq 'length')
            COMMENT_COUNT=$(echo "$COMMENTS" | jq 'length')

            if [ "$REVIEW_COUNT" -eq 0 ] && [ "$COMMENT_COUNT" -eq 0 ]; then
              echo "No greptile comments on PR #${PR_NUMBER}. Skipping."
              continue
            fi

            echo "Found ${REVIEW_COUNT} review(s) and ${COMMENT_COUNT} inline comment(s) from greptile."

            # Build the issue body
            BODY_FILE=$(mktemp)

            printf '> Greptile review for [PR #%s](%s) on `%s`\n\n' "$PR_NUMBER" "$PR_URL" "$UPSTREAM_REPO" > "$BODY_FILE"

            # Add review summaries
            if [ "$REVIEW_COUNT" -gt 0 ]; then
              printf '## Review Summary\n\n' >> "$BODY_FILE"
              echo "$REVIEWS" | jq -r '.[].body' | while IFS= read -r line; do
                printf '%s\n' "$line" >> "$BODY_FILE"
              done
              printf '\n' >> "$BODY_FILE"
            fi

            # Add inline comments
            if [ "$COMMENT_COUNT" -gt 0 ]; then
              printf '## Inline Comments\n\n' >> "$BODY_FILE"
              echo "$COMMENTS" | jq -c '.[]' | while IFS= read -r comment; do
                FILE_PATH=$(echo "$comment" | jq -r '.path')
                START_LINE=$(echo "$comment" | jq -r '.start_line')
                END_LINE=$(echo "$comment" | jq -r '.line')
                COMMENT_BODY=$(echo "$comment" | jq -r '.body')

                if [ "$START_LINE" != "null" ] && [ "$START_LINE" != "$END_LINE" ]; then
                  printf '### `%s` (lines %s-%s)\n\n' "$FILE_PATH" "$START_LINE" "$END_LINE" >> "$BODY_FILE"
                else
                  printf '### `%s` (line %s)\n\n' "$FILE_PATH" "$END_LINE" >> "$BODY_FILE"
                fi

                printf '%s\n\n' "$COMMENT_BODY" >> "$BODY_FILE"
              done
            fi

            # Create the issue
            gh issue create --repo "$DEV_REPO" --title "$ISSUE_TITLE" --body-file "$BODY_FILE"
            rm -f "$BODY_FILE"
            echo "Created issue: ${ISSUE_TITLE}"
          done

          echo "=========="
          echo "All PRs processed."
